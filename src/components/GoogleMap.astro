---
export interface Props {
  center: {
    lat: number;
    lng: number;
  };
  zoom: number;
  title: string;
}

const { center, zoom, title } = Astro.props;
---

<div 
  id="google-map" 
  class="w-full h-96 rounded-lg shadow-md bg-gray-300 flex items-center justify-center"
  data-center={JSON.stringify(center)}
  data-zoom={zoom}
  data-title={title}
>
  <div class="text-center">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
    <p class="text-gray-600">Loading interactive map...</p>
  </div>
</div>

<script>
  // Google Maps initialization function
  function initMap() {
    const mapElement = document.getElementById('google-map');
    if (!mapElement) return;

    const center = JSON.parse(mapElement.dataset.center || '{"lat": 51.8721, "lng": 0.1604}');
    const zoom = parseInt(mapElement.dataset.zoom || '13');
    const title = mapElement.dataset.title || 'Windows Bishop\'s Stortford';

    // Create map
    const map = new google.maps.Map(mapElement, {
      center: center,
      zoom: zoom,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    // Add marker
    const marker = new google.maps.Marker({
      position: center,
      map: map,
      title: title,
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <circle cx="20" cy="20" r="18" fill="#2563eb" stroke="#ffffff" stroke-width="3"/>
            <circle cx="20" cy="20" r="8" fill="#ffffff"/>
          </svg>
        `),
        scaledSize: new google.maps.Size(40, 40),
        anchor: new google.maps.Point(20, 20)
      }
    });

    // Add info window
    const infoWindow = new google.maps.InfoWindow({
      content: `
        <div class="p-2">
          <h3 class="font-bold text-blue-900">${title}</h3>
          <p class="text-sm text-gray-600">Serving Bishop's Stortford & surrounding areas</p>
          <p class="text-sm mt-2">
            <a href="tel:01279123456" class="text-blue-600 hover:text-blue-800">
              ðŸ“ž 01279 123456
            </a>
          </p>
        </div>
      `
    });

    marker.addListener('click', () => {
      infoWindow.open(map, marker);
    });

    // Auto-open info window after a delay
    setTimeout(() => {
      infoWindow.open(map, marker);
    }, 1000);
  }

  // Load Google Maps API if not already loaded
  function loadGoogleMaps() {
    if (typeof google !== 'undefined' && google.maps) {
      initMap();
      return;
    }

              // Create script element
          const apiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;
          if (!apiKey) {
            console.error('PUBLIC_GOOGLE_MAPS_API_KEY is not configured');
            mapElement.innerHTML = '<div class="text-center p-8"><p class="text-red-600">Google Maps API key not configured</p></div>';
            return;
          }
          
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=&v=weekly`;
          script.async = true;
          script.defer = true;
    
    // Make initMap globally available
    window.initMap = initMap;
    
    document.head.appendChild(script);
  }

  // Initialize when component is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleMaps);
  } else {
    loadGoogleMaps();
  }
</script> 